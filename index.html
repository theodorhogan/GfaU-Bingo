<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Golf fÃ¼r arme Unternehmer Bingo</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <header>
    <h1 id="game-title">Bingo</h1>
    <p class="subtitle" id="game-subtitle">LÃ¤dt...</p>
  </header>

  <div id="year-tabs" role="tablist" aria-label="Jahr auswÃ¤hlen"></div>

  <section id="called-panel">
    <h2 id="called-heading"></h2>
    <div id="called-list"></div>
  </section>

  <section id="expired-panel" style="display:none">
    <h2 id="expired-heading"></h2>
    <div id="expired-list"></div>
  </section>

  <div id="error" style="display:none"></div>
  <section id="players"></section>

  <footer>
    <p id="footer-text"></p>
  </footer>

  <script>
    // â”€â”€ Global state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let currentLang      = 'de';
    let currentYearData  = null;
    let allYears         = [];
    let translations     = {};

    // â”€â”€ UI strings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const UI = {
      de: {
        loading:        'LÃ¤dt...',
        calledHeading:  'Was ist schon dieses Jahr passiert?',
        expiredHeading: 'Kann nicht mehr passieren',
        nothingYet:     'Noch nichts passiert.',
        hitLabel:       'Treffer',
        expiredLabel:   'abgelaufen',
        playersLabel:   'Spieler',
        scoreLabel:     'getroffen',
        footerText:     'Zuletzt aktualisiert beim letzten Push &mdash; <a href="https://github.com/theodorhogan/GfaU-Bingo" target="_blank" rel="noopener">Auf GitHub ansehen</a>',
        langBtn:        'EN',
      },
      en: {
        loading:        'Loading...',
        calledHeading:  'What has already happened this year?',
        expiredHeading: 'Can no longer happen',
        nothingYet:     'Nothing yet.',
        hitLabel:       'hits',
        expiredLabel:   'expired',
        playersLabel:   'players',
        scoreLabel:     'called',
        footerText:     'Last updated on last push &mdash; <a href="https://github.com/theodorhogan/GfaU-Bingo" target="_blank" rel="noopener">View on GitHub</a>',
        langBtn:        'DE',
      }
    };

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const FREE_LABELS = ["FREE SPACE", "FREE", "WILD", "FREE SQUARE", "O"];

    function isFree(text) {
      return FREE_LABELS.includes(text.trim().toUpperCase());
    }

    function normalize(str) {
      return str.trim().toLowerCase();
    }

    function escHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    // Translate a sentence if EN mode is active
    function tr(sentence) {
      if (currentLang === 'en') {
        return translations[normalize(sentence)] || sentence;
      }
      return sentence;
    }

    // â”€â”€ Bingo check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function checkBingo(cells, calledSet, gridSize) {
      const grid = [];
      for (let r = 0; r < gridSize; r++) {
        grid.push(cells.slice(r * gridSize, (r + 1) * gridSize));
      }
      const hit = (cell) => isFree(cell) || calledSet.has(normalize(cell));

      for (let r = 0; r < gridSize; r++) {
        if (grid[r].every(hit)) return true;
      }
      for (let c = 0; c < gridSize; c++) {
        if (grid.map(row => row[c]).every(hit)) return true;
      }
      if (grid.map((row, i) => row[i]).every(hit)) return true;
      if (grid.map((row, i) => row[gridSize - 1 - i]).every(hit)) return true;

      return false;
    }

    // â”€â”€ Render: year tabs + lang toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderControls(years, activeYear) {
      const container = document.getElementById("year-tabs");
      container.innerHTML = "";

      years.forEach(yearData => {
        const btn = document.createElement("button");
        btn.className = "year-tab" + (yearData.year === activeYear ? " active" : "");
        btn.textContent = yearData.year;
        btn.setAttribute("role", "tab");
        btn.setAttribute("aria-selected", yearData.year === activeYear);
        btn.onclick = () => loadYear(yearData);
        container.appendChild(btn);
      });

      // Language toggle â€” pushed to the right
      const lang = document.createElement("button");
      lang.id = "lang-toggle";
      lang.className = "lang-btn";
      lang.textContent = UI[currentLang].langBtn;
      lang.title = currentLang === 'de' ? 'Switch to English' : 'Auf Deutsch wechseln';
      lang.onclick = () => {
        currentLang = currentLang === 'de' ? 'en' : 'de';
        document.documentElement.lang = currentLang;
        if (currentYearData) loadYear(currentYearData);
      };
      container.appendChild(lang);
    }

    // â”€â”€ Render: called panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderCalledPanel(calledSentences) {
      const ui = UI[currentLang];
      document.getElementById("called-heading").textContent = ui.calledHeading;
      const list = document.getElementById("called-list");
      if (calledSentences.length === 0) {
        list.innerHTML = `<span class="none-called">${ui.nothingYet}</span>`;
        return;
      }
      list.innerHTML = calledSentences
        .map(s => `<span class="called-tag">${escHtml(tr(s))}</span>`)
        .join("");
    }

    // â”€â”€ Render: expired panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderExpiredPanel(expiredSentences) {
      const panel = document.getElementById("expired-panel");
      if (!expiredSentences || expiredSentences.length === 0) {
        panel.style.display = "none";
        return;
      }
      panel.style.display = "block";
      document.getElementById("expired-heading").textContent = UI[currentLang].expiredHeading;
      document.getElementById("expired-list").innerHTML = expiredSentences
        .map(s => `<span class="expired-tag">${escHtml(tr(s))}</span>`)
        .join("");
    }

    // â”€â”€ Render: single player card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderPlayer(player, calledSet, expiredSet, secretSet, gridSize) {
      const card = document.createElement("div");
      card.className = "player-card";

      const calledCount = player.card.filter(
        c => !isFree(c) && !secretSet.has(normalize(c)) && calledSet.has(normalize(c))
      ).length;
      const totalNonFree = player.card.filter(
        c => !isFree(c) && !secretSet.has(normalize(c))
      ).length;

      if (checkBingo(player.card, calledSet, gridSize)) {
        const banner = document.createElement("div");
        banner.className = "bingo-banner";
        banner.textContent = "ðŸŽ‰ BINGO!";
        card.appendChild(banner);
      }

      const nameEl = document.createElement("div");
      nameEl.className = "player-name";
      nameEl.innerHTML = `
        <span>${escHtml(player.name)}</span>
        <span class="player-score">${calledCount} / ${totalNonFree} ${UI[currentLang].scoreLabel}</span>
      `;
      card.appendChild(nameEl);

      const grid = document.createElement("div");
      grid.className = "bingo-grid";
      grid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;

      player.card.forEach(sentence => {
        const cell = document.createElement("div");
        cell.className = "bingo-cell";

        if (isFree(sentence)) {
          cell.classList.add("free");
          cell.textContent = sentence.trim().toUpperCase() === "O" ? "O" : "FREE";
        } else if (expiredSet.has(normalize(sentence))) {
          cell.classList.add("expired");
          cell.textContent = tr(sentence);
        } else if (calledSet.has(normalize(sentence))) {
          cell.classList.add("called");
          if (secretSet.has(normalize(sentence))) cell.classList.add("secret");
          cell.textContent = tr(sentence);
        } else if (secretSet.has(normalize(sentence))) {
          cell.classList.add("secret");
          cell.textContent = tr(sentence);
        } else {
          cell.textContent = tr(sentence);
        }

        grid.appendChild(cell);
      });

      card.appendChild(grid);
      return card;
    }

    // â”€â”€ Load a year â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function loadYear(yearData) {
      currentYearData = yearData;

      const calledSet  = new Set(yearData.calledSentences.map(normalize));
      const expiredSet = new Set((yearData.expiredSentences || []).map(normalize));
      const secretSet  = new Set((yearData.secrets || []).map(normalize));
      const gridSize   = yearData.gridSize || 5;
      const ui         = UI[currentLang];

      const called  = yearData.calledSentences.length;
      const expired = (yearData.expiredSentences || []).length;
      const parts   = [`${yearData.year}`, `${called} ${ui.hitLabel}`];
      if (expired > 0) parts.push(`${expired} ${ui.expiredLabel}`);
      parts.push(`${yearData.players.length} ${ui.playersLabel}`);
      document.getElementById("game-subtitle").textContent = parts.join(" Â· ");

      document.getElementById("footer-text").innerHTML = ui.footerText;

      renderControls(allYears, yearData.year);
      renderCalledPanel(yearData.calledSentences);
      renderExpiredPanel(yearData.expiredSentences || []);

      const playersEl = document.getElementById("players");
      playersEl.innerHTML = "";
      yearData.players.forEach(player => {
        playersEl.appendChild(renderPlayer(player, calledSet, expiredSet, secretSet, gridSize));
      });
    }

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function init() {
      try {
        const res = await fetch("data.json", { cache: "no-cache" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        allYears     = data.years || [];
        translations = data.translations || {};

        if (allYears.length === 0) throw new Error("No year data found");

        document.title = data.title || "Bingo";
        document.getElementById("game-title").textContent = data.title || "Bingo";

        loadYear(allYears[0]);

      } catch (err) {
        document.getElementById("error").style.display = "block";
        document.getElementById("error").textContent = `Fehler beim Laden: ${err.message}`;
        document.getElementById("game-subtitle").textContent = "Fehler";
      }
    }

    init();
  </script>
</body>
</html>
