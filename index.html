<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Golf fÃ¼r arme Unternehmer Bingo</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <header>
    <h1 id="game-title">Bingo</h1>
    <p class="subtitle" id="game-subtitle">LÃ¤dt...</p>
  </header>

  <div id="year-tabs" role="tablist" aria-label="Jahr auswÃ¤hlen"></div>

  <section id="called-panel">
    <h2>Was ist schon dieses Jahr passiert?</h2>
    <div id="called-list"></div>
  </section>

  <section id="expired-panel" style="display:none">
    <h2>Kann nicht mehr passieren</h2>
    <div id="expired-list"></div>
  </section>

  <div id="error" style="display:none"></div>
  <section id="players"></section>

  <footer>
    <p>Zuletzt aktualisiert beim letzten Push &mdash; <a href="https://github.com/theodorhogan/GfaU-Bingo" target="_blank" rel="noopener">Auf GitHub ansehen</a></p>
  </footer>

  <script>
    const FREE_LABELS = ["FREE SPACE", "FREE", "WILD", "FREE SQUARE", "O"];

    function isFree(text) {
      return FREE_LABELS.includes(text.trim().toUpperCase());
    }

    function normalize(str) {
      return str.trim().toLowerCase();
    }

    function escHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;");
    }

    function checkBingo(cells, calledSet, gridSize) {
      const grid = [];
      for (let r = 0; r < gridSize; r++) {
        grid.push(cells.slice(r * gridSize, (r + 1) * gridSize));
      }
      // Expired cells are NOT in calledSet, so they naturally don't count
      const hit = (cell) => isFree(cell) || calledSet.has(normalize(cell));

      for (let r = 0; r < gridSize; r++) {
        if (grid[r].every(hit)) return true;
      }
      for (let c = 0; c < gridSize; c++) {
        if (grid.map(row => row[c]).every(hit)) return true;
      }
      if (grid.map((row, i) => row[i]).every(hit)) return true;
      if (grid.map((row, i) => row[gridSize - 1 - i]).every(hit)) return true;

      return false;
    }

    function renderYearTabs(years, activeYear) {
      const container = document.getElementById("year-tabs");
      container.innerHTML = "";
      years.forEach(yearData => {
        const btn = document.createElement("button");
        btn.className = "year-tab" + (yearData.year === activeYear ? " active" : "");
        btn.textContent = yearData.year;
        btn.setAttribute("role", "tab");
        btn.setAttribute("aria-selected", yearData.year === activeYear);
        btn.onclick = () => loadYear(yearData, years);
        container.appendChild(btn);
      });
    }

    function renderCalledPanel(calledSentences) {
      const list = document.getElementById("called-list");
      if (calledSentences.length === 0) {
        list.innerHTML = '<span class="none-called">Noch nichts passiert.</span>';
        return;
      }
      list.innerHTML = calledSentences
        .map(s => `<span class="called-tag">${escHtml(s)}</span>`)
        .join("");
    }

    function renderExpiredPanel(expiredSentences) {
      const panel = document.getElementById("expired-panel");
      if (!expiredSentences || expiredSentences.length === 0) {
        panel.style.display = "none";
        return;
      }
      panel.style.display = "block";
      document.getElementById("expired-list").innerHTML = expiredSentences
        .map(s => `<span class="expired-tag">${escHtml(s)}</span>`)
        .join("");
    }

    function renderPlayer(player, calledSet, expiredSet, secretSet, gridSize) {
      const card = document.createElement("div");
      card.className = "player-card";

      const calledCount = player.card.filter(
        c => !isFree(c) && !secretSet.has(normalize(c)) && calledSet.has(normalize(c))
      ).length;
      const totalNonFree = player.card.filter(
        c => !isFree(c) && !secretSet.has(normalize(c))
      ).length;

      const hasBingo = checkBingo(player.card, calledSet, gridSize);

      if (hasBingo) {
        const banner = document.createElement("div");
        banner.className = "bingo-banner";
        banner.textContent = "ðŸŽ‰ BINGO!";
        card.appendChild(banner);
      }

      const nameEl = document.createElement("div");
      nameEl.className = "player-name";
      nameEl.innerHTML = `
        <span>${escHtml(player.name)}</span>
        <span class="player-score">${calledCount} / ${totalNonFree} getroffen</span>
      `;
      card.appendChild(nameEl);

      const grid = document.createElement("div");
      grid.className = "bingo-grid";
      grid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;

      player.card.forEach(sentence => {
        const cell = document.createElement("div");
        cell.className = "bingo-cell";

        if (isFree(sentence)) {
          cell.classList.add("free");
          cell.textContent = sentence.trim().toUpperCase() === "O" ? "O" : "FREE";
        } else if (expiredSet.has(normalize(sentence))) {
          cell.classList.add("expired");
          cell.textContent = sentence;
        } else if (calledSet.has(normalize(sentence))) {
          cell.classList.add("called");
          if (secretSet.has(normalize(sentence))) cell.classList.add("secret");
          cell.textContent = sentence;
        } else if (secretSet.has(normalize(sentence))) {
          cell.classList.add("secret");
          cell.textContent = sentence;
        } else {
          cell.textContent = sentence;
        }

        grid.appendChild(cell);
      });

      card.appendChild(grid);
      return card;
    }

    function loadYear(yearData, allYears) {
      const calledSet  = new Set(yearData.calledSentences.map(normalize));
      const expiredSet = new Set((yearData.expiredSentences || []).map(normalize));
      const secretSet  = new Set((yearData.secrets || []).map(normalize));
      const gridSize   = yearData.gridSize || 5;

      const called   = yearData.calledSentences.length;
      const expired  = (yearData.expiredSentences || []).length;
      const subtitle = `${yearData.year} Â· ${called} Treffer Â· ${expired > 0 ? expired + " abgelaufen Â· " : ""}${yearData.players.length} Spieler`;
      document.getElementById("game-subtitle").textContent = subtitle;

      renderYearTabs(allYears, yearData.year);
      renderCalledPanel(yearData.calledSentences);
      renderExpiredPanel(yearData.expiredSentences || []);

      const playersEl = document.getElementById("players");
      playersEl.innerHTML = "";
      yearData.players.forEach(player => {
        playersEl.appendChild(renderPlayer(player, calledSet, expiredSet, secretSet, gridSize));
      });
    }

    async function init() {
      try {
        const res = await fetch("data.json", { cache: "no-cache" });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        const years = data.years || [];
        if (years.length === 0) throw new Error("Keine Jahresdaten gefunden");

        document.title = data.title || "Bingo";
        document.getElementById("game-title").textContent = data.title || "Bingo";

        // Default to the most recent year (first in array)
        loadYear(years[0], years);

      } catch (err) {
        document.getElementById("error").style.display = "block";
        document.getElementById("error").textContent =
          `Fehler beim Laden: ${err.message}`;
        document.getElementById("game-subtitle").textContent = "Fehler";
      }
    }

    init();
  </script>
</body>
</html>
